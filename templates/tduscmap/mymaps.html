{% extends 'base.html' %}
{% block content %}

{% load static %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="icon" type="image/png" href="{% static 'images/favicon.png' %}">
<link rel="stylesheet" href="{% static 'stylesmymaps.css' %}" type="text/css">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<div class="container text-center px-5">
    <!-- Image de la bannière -->
    <div class="image-container">
        <img id="banner" src="{% static 'images/sharps_Luxe.1d79d72.jpg' %}" alt="Bannière Test Drive" />
        <img id="banner" src="{% static 'images/test-drive-unlimited-solar-crown-header-art2.jpg' %}" alt="Bannière Solar Hotel" />
        <img id="banner" src="{% static 'images/sharps_Solar_Hotel.2342470.jpg' %}" alt="Bannière key of Test Drive" />
    </div> 

    <h1 id="footer">Ma carte</h1>
    
    <!-- Formulaire de recherche -->
    <form id="searchForm" method="GET" action="{% url 'search_friends' %}">
        <input type="text" id="searchInput" name="search" placeholder="Rechercher un utilisateur">
        <button type="submit">Rechercher</button>
    </form>
    
    <!-- Zone des résultats de recherche -->
    <div id="searchResults"></div>
    
    <!-- Div où la carte va être affichée -->
    <div id="container">
        <div id="menu">
            <button id="toggle-all" class="menu-btn" data-fr="Afficher/Cacher tout" data-en="Show/Hide All">Afficher/Cacher tout</button>
            <select id="friendSelect">
                <option value="">Choisir un ami</option>
                <!-- Options pour les amis seront ajoutées ici dynamiquement -->
            </select>
        </div>
        <div id="map"></div>
    </div>

    <footer>
        <div class="container2">
            <p>By <a href="https://www.youtube.com/@fcr_77" target="_blank">FCR</a> Septembre 2024</p>
            <a href="https://www.mon-compteur.fr">
                <img src="https://www.mon-compteur.fr/html_c01genv2-242818-3" alt="compteur" border="0" />
            </a><br>
        </div>
    </footer>  
</div>

<!-- Inclure le JS de Leaflet -->
<script src="{% static 'js/map.js' %}"></script>
<script src="{% static 'js/mymaps.js' %}"></script>

<script>
  // Récupère l'ID de l'utilisateur actuellement connecté depuis Django
  const currentUserId = "{{ request.user.id }}";

  // Gestionnaire d'événements pour le formulaire de recherche
  document.getElementById('searchForm').addEventListener('submit', function(event) {
      event.preventDefault(); // Empêche l'envoi du formulaire classique

      const searchQuery = document.getElementById('searchInput').value;
      const resultsContainer = document.getElementById('searchResults');

      fetch(`/search-friends/?search=${encodeURIComponent(searchQuery)}`)
          .then(response => response.json())
          .then(data => {
              resultsContainer.innerHTML = ''; // Vide les anciens résultats
              if (data.users.length > 0) {
                  data.users.forEach(user => {
                      const userElement = document.createElement('div');
                      userElement.innerHTML = `
                          <p>${user.username} <button onclick="addFriend(${currentUserId}, ${user.id})">Ajouter en ami</button></p>
                      `;
                      resultsContainer.appendChild(userElement);
                  });
              } else {
                  resultsContainer.innerHTML = '<p>Aucun utilisateur trouvé.</p>';
              }
          })
          .catch(error => {
              resultsContainer.innerHTML = '<p>Erreur lors de la recherche.</p>';
              console.error("Erreur lors de la recherche :", error);
          });
  });

  // Fonction pour ajouter un ami
  function addFriend(userId, friendId) {
      fetch(`/add-friend/${userId}/`, {
          method: 'POST',
          headers: {
              'X-CSRFToken': '{{ csrf_token }}', // Nécessaire pour Django
              'Content-Type': 'application/json'
          },
          body: JSON.stringify({
              friend_id: friendId  // Envoyer l'ID de l'ami dans le corps de la requête
          })
      })
      .then(response => response.json())
      .then(data => {
          if (data.success) {
              alert(data.message);  // Afficher un message de succès
          } else {
              alert('Erreur : ' + data.message);  // Afficher un message d'erreur
          }
      })
      .catch(error => {
          console.error("Erreur lors de l'ajout de l'ami :", error);
      });
  }
</script>



{% endblock content %}
